package io.mixeway.db.repository;

import java.util.List;
import java.util.Optional;
import java.util.Set;
import java.util.stream.Stream;

import io.mixeway.db.entity.Software;
import io.mixeway.pojo.BarChartProjection2;
import org.springframework.data.jpa.repository.JpaRepository;
import org.springframework.data.jpa.repository.Modifying;
import org.springframework.data.jpa.repository.Query;
import org.springframework.data.repository.query.Param;

import io.mixeway.db.entity.SoftwarePacket;
import io.mixeway.db.entity.SoftwarePacketVulnerability;

public interface SoftwarePacketVulnerabilityRepository extends JpaRepository<SoftwarePacketVulnerability, Long> {

	Long deleteBySoftwarepacket(SoftwarePacket softwarepacket);
	List<SoftwarePacketVulnerability> findBySoftwarepacketIn(Set<SoftwarePacket> packets);
	Optional<SoftwarePacketVulnerability> findByName(String name);
	Optional<SoftwarePacketVulnerability> findBySoftwarepacketAndName(SoftwarePacket softwarePacket, String name);
	@Modifying
	@Query(value="delete from softwarepacketvulnerability spv where spv.softwarepacket_id=:id", nativeQuery = true)
	public void deleteVulnsForPacket(@Param("id")Long id);
	@Query(value="select spv.* from softwarepacketvulnerability spv, codeproject_softwarepacket csp where spv.softwarepacket_id = csp.softwarepacket_id " +
			"and csp.codeproject_id in (select id from codeproject where codegroup_id in (select id from codegroup where project_id = ?1))", nativeQuery = true)
	List<SoftwarePacketVulnerability> getSoftwareVulnsForProject(@Param("id") Long id);
	@Query(value="select spv.* from softwarepacketvulnerability spv, codeproject_softwarepacket csp where spv.softwarepacket_id = csp.softwarepacket_id " +
			"and csp.codeproject_id in (select id from codeproject where codegroup_id in (select id from codegroup where project_id = ?1)) and spv.severity = ?2", nativeQuery = true)
	List<SoftwarePacketVulnerability> getSoftwareVulnsForProjectAndSeverity(@Param("id") Long id, @Param("severity") String severity);
	@Query(value="select distinct(spv.*) from softwarepacketvulnerability spv, codeproject_softwarepacket csp where spv.softwarepacket_id = csp.softwarepacket_id " +
			"and csp.codeproject_id = ?1", nativeQuery = true)
	List<SoftwarePacketVulnerability> getSoftwareVulnsForCodeProject(@Param("id") Long id);
	@Query(value="select distinct(spv.*) from softwarepacketvulnerability spv, codeproject_softwarepacket csp where spv.softwarepacket_id = csp.softwarepacket_id " +
			"and csp.codeproject_id = :id and spv.severity=:severity", nativeQuery = true)
	List<SoftwarePacketVulnerability> getSoftwareVulnsForCodeProjectAndSeverity(@Param("id") Long id, @Param("severity") String severity);
	@Query(value="select distinct(spv.*) from softwarepacketvulnerability spv, codeproject_softwarepacket csp where spv.softwarepacket_id = csp.softwarepacket_id " +
			"and csp.codeproject_id = ?1", nativeQuery = true)
	Stream<SoftwarePacketVulnerability> getSoftwareVulnsForCodeProjectWithStream(@Param("id") Long id);

	@Query(value = "select count(spv) as value, sp.name as namee from softwarepacket sp inner join softwarepacketvulnerability spv on spv.softwarepacket_id=sp.id where " +
			"spv.severity in ('Critic', 'Critical', 'High') group by sp.name order by value desc limit 10", nativeQuery = true)
	List<BarChartProjection2> getTopOpenSourceVulns();

	@Query(value = "select count(spv) as value, cp.name as namee from codeproject cp inner join codeproject_softwarepacket cs on cp.id = cs.codeproject_id " +
			"inner join softwarepacketvulnerability spv on cs.softwarepacket_id = spv.softwarepacket_id where spv.severity in ('Critic', 'Critical', 'High') " +
			"group by cp.name order by value desc limit 10", nativeQuery = true)
	List<BarChartProjection2> getTopOpenSourceVulnsForCodeProject();
}
